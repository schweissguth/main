<!doctype html>
<html>
  <head>
    <title>Picks - StupidFast</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="./css.css" />

    <style>
      tr {
        height: 80px;
      }
    </style>
  </head>
  <body>
    <center>
      <br /><br />

      <a href="../" class="banner" width="100%">
        <img src="./sfbanner.png" width="100%" />
      </a>

      <br /><br />
      <table id="table" cellpadding="3">
        <tr>
          <td>LOADING...</td>
        </tr>
      </table>
    </center>

    <script>
      var RACEID = 0
      var PREVRACE = 0
      var PLAYERS = []

      function getRaceId() {
        fetch(
          "https://script.google.com/macros/s/AKfycbzbY9NDapp1MxzkVxDR9XI6uj-TnDwnkZMupshwY7M3uOl8uyaJrBYCzYY5au9XdobO/exec?sheet=PLAYERS&ACTIVE=1",
        )
          .then(function (res) {
            return res.json()
          })
          .then(function (res) {
            console.log(res)
            res.sort(function (a, b) {
              return a.PICKORDER - b.PICKORDER
            })
            table.innerHTML = null
            PREVRACE = res[0].PREVRACE
            RACEID = res[0].RACENO
            PLAYERS = res
            getDrivers()
          })
      }

      getRaceId()

      function getDrivers() {
        fetch(
          "https://cf.nascar.com/live/feeds/series_1/" +
            PREVRACE +
            "/live_points.json",
        )
          .then(function (res) {
            return res.json()
          })
          .then(function (res) {
            console.log(res)
            res.forEach(function (driver) {
              var tr = table.insertRow()
              var td0 = tr.insertCell()
              td0.id = driver.driver_id
              tr.insertCell().innerText =
                driver.first_name + " " + driver.last_name
              var td = tr.insertCell()
              var select = document.createElement("SELECT")
              var option = document.createElement("OPTION")
              select.append(option)
              PLAYERS.forEach(function (player) {
                var opt = document.createElement("OPTION")
                opt.text = player.NAME
                opt.value = player.ID
                if (
                  player.PICKS.includes(driver.driver_id) &&
                  driver.driver_id != 0
                ) {
                  opt.selected = true
                }
                select.add(opt)
              })
              select.onchange = function () {
                fetch(
                  "https://script.google.com/macros/s/AKfycbwyx5JZpneWX4L_GyEike2Z8Bqjmgy-8qrNOTVORBSi1ErN6AWO7E8rNM8HIc5bS2nW/exec?PICKS",
                  {
                    method: "post",
                    body: JSON.stringify({
                      PLAYERID: select.value,
                      DRIVERID: driver.driver_id,
                    }),
                  },
                )
                  .then(function (res) {
                    return res.text()
                  })
                  .then(function (res) {
                    alert(res)
                  })
              }
              td.append(select)
            })
            var td13 = table.insertRow(13).insertCell()
            td13.setAttribute("colspan", 3)
            td13.innerHTML = "<hr>"
            getImages()
          })
      }

      function getImages() {
        fetch("https://cf.nascar.com/cacher/drivers.json")
          .then(function (res) {
            return res.json()
          })
          .then(function (images) {
            images.response.forEach(function (image) {
              try {
                var td = document.getElementById(image.Nascar_Driver_ID)
                td.innerHTML =
                  "<img src='" + image.Image_Small + "' width='50' />"
              } catch (err) {}
            })
          })
      }
    </script>
  </body>
</html>
