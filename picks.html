<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="./css.css" />
    <script src="https://stupid-fast.com/server.js"></script>
    <title>Stupid-Fast.com - make picks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        function getGroupLines(x) {
            return fetch(
                "https://sheets.googleapis.com/v4/spreadsheets/1jwadkJYYfBmf-SbjUokDV0S_yzC7gD39-jHxVatJfLU/values/PICKS?key=AIzaSyDIEdL4EcBenrWDkh03oFYmFvHT_VNH3AI",
            )
                .then(function (res) {
                    return res.json()
                })
                .then(function (res) {
                    if (x) {
                        return res.values.makeObj().filter(function (filter) {
                            return filter.RACEID == x
                        })
                    } else {
                        return res.values.makeObj()
                    }
                })
        }
    </script>
</head>

<body>
    <header>
        <a href="./index.html"><img src="./sfbanner.png" alt="" /></a>
    </header>

    <section>
        <span id="spanplayerid">Hello, </span>! <a href="./players.html" style="display: inline;"
            onclick="localStorage.removeItem('playerid')">Log out</a>?
    </section>

    <main id="main">
    </main>
</body>

<script>

    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search)
    const playerid = params.get('player')
    if (!playerid) {
        window.location.href = "./players.html"
    }
    spanplayerid.innerText += playerid.toUpperCase()

    nextRace().then(function (res) {
        const raceid = res
        getPickOrder().then(function (res) {
            console.log(res)
            let group = res.find(function (each) {
                return each.PLAYERID == playerid
            })
            getStandings().then(function (res) {
                console.log(res)
                res.forEach(function (each) {
                    let span = document.createElement('span')
                    span.title = each.driver_id
                    let lbl = document.createElement('label')
                    lbl.style.display = "table";
                    span.innerText = each.driver_name + " "
                    let cb = document.createElement('input')
                    cb.id = each.driver_id
                    cb.type = "checkbox"
                    cb.disabled = true
                    cb.onchange = function () {
                        let arr = [Date.now(), raceid, each.driver_id, playerid, group.GROUPID, each.driver_name]
                        if (!cb.checked) {
                            arr[2] = ""
                        }
                        fetch("https://script.google.com/macros/s/AKfycbyEGYd3C0Zgd-mHbBrjDrdMUSsYvj_7oky1yIuffDrRk8rURlR-gV_IteIJHzznntfO/exec?PICKS", {
                            method: 'POST',
                            body: JSON.stringify([arr]),
                        }).then(function (res) {
                            return res.text()
                        }).then(function (res) {
                            console.log(res)
                        })
                    }
                    let img = document.createElement('img')
                    img.src = "https://cf.nascar.com/data/images/carbadges/1/" + each.car_no + ".png"
                    img.width = 50
                    img.style.verticalAlign = "middle"
                    img.style.margin = "0px 5px"
                    lbl.appendChild(cb)
                    lbl.appendChild(img)
                    lbl.appendChild(span)
                    main.appendChild(lbl)
                })


                getPicks().then(function (res) {
                    document.querySelectorAll("input[type=checkbox]").forEach(function (each) {
                        each.disabled = false
                    })
                    res = res.filter(function (each) {
                        return each.RACEID == raceid && each.GROUPID == group.GROUPID
                    })
                    console.log(res)
                    res.forEach(function (each) {
                        let cb = document.getElementById(each.DRIVERID)
                        if (each.PLAYERID == playerid) {
                            cb.checked = true
                            cb.disabled = false
                            cb.title = each.PLAYERID
                        } else if (each.PLAYERID) {
                            cb.checked = true
                            cb.disabled = true
                            cb.title = each.PLAYERID

                        } else {
                            cb.checked = false
                            cb.disabled = false
                        }
                    })
                    addSeparator()
                })


            })
        })

    });

    function addSeparator() {
        let sep = document.createElement('hr')
        document.querySelectorAll("label")[10].before(sep)
    }



</script>

</html>
