<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Results - StupidFast</title>
    <script src="https://stupid-fast.com/server.js?jjjjj"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./server.js"></script>
    <link rel="stylesheet" type="text/css" href="./css.css" />
  </head>

  <body>
    <header>
      <a href="./index.html"><img src="./sfbanner.png" alt="" /></a>
    </header>

    <main>
      <select id="selectrace" onchange="showRace(this.value)"></select>
    </main>
    <section id="infosection"></section>

    <table id="t"></table>

    <script>
      let SCHEDULE = []

      getSchedule().then(function (races) {
        SCHEDULE = races
        nextRace().then(function (currentrace) {
          races.forEach(function (race) {
            let opt = document.createElement('OPTION')
            opt.value = race.race_id
            opt.text = race.track_name
            selectrace.add(opt)
          })
          selectrace.value = currentrace
          showRace(currentrace)
        })
      })

      async function showRace(raceid) {
        const race = SCHEDULE.find((r) => r.race_id == raceid)
        infosection.innerHTML = ''
        infosection.innerHTML += race.race_name + '<br>'
        infosection.innerHTML +=
          new Date(race.date_scheduled).toLocaleString() + '<br>'
        infosection.innerHTML +=
          race.television_broadcaster + ' / ' + race.radio_broadcaster + '<br>'
        infosection.innerHTML += '<i>' + race.race_comments + '</i>' + '<br>'
        if (race.winner_driver_id) {
          let results = await getResults(race.race_id)
          let players = await playersobj()
          results = results.filter(function (x) {
            return x.finishing_position > 0
          })
          console.log(results)
          results.forEach(function (driver) {
            let tr = t.insertRow()
            tr.insertCell().innerText = driver.finishing_position
            tr.insertCell().innerText = driver.driver_fullname
            tr.insertCell().id = driver.driver_id
          })
          driverscoresobj(raceid).then(function (scores) {
            console.log(scores)
            scores.forEach(function (score, s) {
              for (let i in score) {
                let td = document.getElementById(i)
                td.innerHTML +=
                  '<div><b>' +
                  players[score[i].PLAYERID].NAME +
                  '</b> <small>' +
                  score[i].SCORE +
                  '</small></div>'
              }
            })
          })
        }
      }
    </script>
  </body>
</html>
